<!DOCTYPE html>
<html lang="ru">
<head>
    <base target="_self">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта слов - Интерактивная карта анонимных меток</title>
    <meta name="description" content="Анонимная карта Москвы, где каждый может оставить текстовую метку и увидеть метки других пользователей в реальном времени">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=ваш_ключ_здесь&lang=ru_RU" type="text/javascript"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        accent: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .ymaps-2-1-79-map {
            border-radius: 12px;
        }
        
        .marker-popup {
            max-width: 300px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .marker-popup h3 {
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .marker-popup p {
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .marker-popup .time {
            color: #6b7280;
            font-size: 14px;
            font-style: italic;
        }
        
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-white">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm border-b border-blue-100 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-3 mb-4 md:mb-0">
                    <div class="w-10 h-10 bg-primary-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-map-marker-alt text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Карта слов</h1>
                        <p class="text-sm text-gray-600">Анонимные метки на карте Москвы</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
                        <i class="fas fa-users text-primary-500"></i>
                        <span>Анонимно • Без регистрации</span>
                    </div>
                    <button id="instructionsBtn" class="px-4 py-2 bg-primary-50 text-primary-700 rounded-lg hover:bg-primary-100 transition-colors">
                        <i class="fas fa-info-circle mr-2"></i>Как это работает
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Panel - Stats -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Статистика</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-map-pin text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Всего меток</p>
                                    <p id="totalMarkers" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-clock text-green-600"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Сегодня</p>
                                    <p id="todayMarkers" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-100">
                            <h3 class="text-sm font-medium text-gray-900 mb-2">Активные метки по времени</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">30 минут</span>
                                    <span id="markers30min" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">1 час</span>
                                    <span id="markers1hour" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">3 часа</span>
                                    <span id="markers3hours" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">12 часов</span>
                                    <span id="markers12hours" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">24 часа</span>
                                    <span id="markers24hours" class="font-medium">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Последние метки</h2>
                    <div id="recentMarkers" class="space-y-3 max-h-80 overflow-y-auto">
                        <!-- Recent markers will be populated here -->
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-map-pin text-3xl mb-3 text-gray-300"></i>
                            <p>Пока нет меток</p>
                            <p class="text-sm mt-1">Кликните на карту, чтобы создать первую</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Карта Москвы</h2>
                            <p class="text-sm text-gray-600">Кликните в любое место, чтобы добавить метку</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="zoomIn" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center transition-colors">
                                <i class="fas fa-plus text-gray-700"></i>
                            </button>
                            <button id="zoomOut" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center transition-colors">
                                <i class="fas fa-minus text-gray-700"></i>
                            </button>
                            <button id="resetView" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Сбросить вид
                            </button>
                        </div>
                    </div>
                    
                    <!-- Map -->
                    <div id="map" class="w-full h-[600px]"></div>
                    
                    <!-- Add Marker Panel (Hidden by default) -->
                    <div id="addMarkerPanel" class="hidden absolute top-4 right-4 w-96 bg-white rounded-xl shadow-xl p-6 slide-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Добавить метку</h3>
                            <button id="closePanel" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                        
                        <form id="markerForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Заголовок</label>
                                <input type="text" id="markerTitle" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                       placeholder="Краткий заголовок" 
                                       maxlength="50"
                                       required>
                                <p class="text-xs text-gray-500 mt-1">Максимум 50 символов</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Текст заметки</label>
                                <textarea id="markerText" 
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                          rows="4"
                                          placeholder="Опишите вашу мысль или наблюдение..."
                                          maxlength="500"
                                          required></textarea>
                                <p class="text-xs text-gray-500 mt-1">Максимум 500 символов</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Время публикации</label>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                                    <label class="relative">
                                        <input type="radio" name="duration" value="30" class="sr-only peer" checked>
                                        <div class="p-3 border border-gray-300 rounded-lg text-center cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 hover:bg-gray-50 transition-colors">
                                            <div class="font-medium text-gray-900">30 мин</div>
                                        </div>
                                    </label>
                                    <label class="relative">
                                        <input type="radio" name="duration" value="60" class="sr-only peer">
                                        <div class="p-3 border border-gray-300 rounded-lg text-center cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 hover:bg-gray-50 transition-colors">
                                            <div class="font-medium text-gray-900">1 час</div>
                                        </div>
                                    </label>
                                    <label class="relative">
                                        <input type="radio" name="duration" value="180" class="sr-only peer">
                                        <div class="p-3 border border-gray-300 rounded-lg text-center cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 hover:bg-gray-50 transition-colors">
                                            <div class="font-medium text-gray-900">3 часа</div>
                                        </div>
                                    </label>
                                    <label class="relative">
                                        <input type="radio" name="duration" value="720" class="sr-only peer">
                                        <div class="p-3 border border-gray-300 rounded-lg text-center cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 hover:bg-gray-50 transition-colors">
                                            <div class="font-medium text-gray-900">12 часов</div>
                                        </div>
                                    </label>
                                    <label class="relative">
                                        <input type="radio" name="duration" value="1440" class="sr-only peer">
                                        <div class="p-3 border border-gray-300 rounded-lg text-center cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 hover:bg-gray-50 transition-colors">
                                            <div class="font-medium text-gray-900">24 часа</div>
                                        </div>
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Метка будет видна на карте указанное время</p>
                            </div>
                            
                            <div class="pt-4 border-t border-gray-100">
                                <button type="submit" class="w-full py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                    <i class="fas fa-paper-plane mr-2"></i>Опубликовать метку
                                </button>
                                <p class="text-xs text-center text-gray-500 mt-3">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Метка будет анонимной и видна всем пользователям
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-mouse-pointer text-blue-600 text-xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-2">Добавьте метку</h3>
                        <p class="text-sm text-gray-600">Кликните в любое место на карте, чтобы добавить свою анонимную метку</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-edit text-green-600 text-xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-2">Напишите сообщение</h3>
                        <p class="text-sm text-gray-600">Заполните заголовок и текст, выберите время публикации</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-eye text-purple-600 text-xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-2">Читайте других</h3>
                        <p class="text-sm text-gray-600">Кликайте на метки на карте, чтобы читать сообщения других пользователей</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 mt-12">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-map-marker-alt text-white"></i>
                        </div>
                        <span class="text-xl font-bold text-gray-900">Карта слов</span>
                    </div>
                    <p class="text-gray-600 mt-2">Анонимная карта мыслей и наблюдений Москвы</p>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-600">
                        <i class="fas fa-shield-alt text-primary-500 mr-1"></i>
                        Без регистрации • Анонимно • В реальном времени
                    </p>
                    <p class="text-sm text-gray-500 mt-2">© 2024 Карта слов. Все метки удаляются автоматически.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Как работает Карта слов</h2>
                    <button id="closeModal" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div class="flex items-start space-x-4">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="font-bold text-blue-600">1</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-2">Добавление метки</h3>
                            <p class="text-gray-600">Кликните в любое место на карте Москвы. Появится форма для создания метки. Заполните заголовок и текст, выберите время публикации (от 30 минут до 24 часов).</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-4">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="font-bold text-green-600">2</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-2">Просмотр меток</h3>
                            <p class="text-gray-600">Все метки от всех пользователей видны на карте в реальном времени. Наведите курсор на метку для подсветки, кликните для просмотра содержимого.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-4">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="font-bold text-purple-600">3</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-2">Анонимность</h3>
                            <p class="text-gray-600">Никакой регистрации и авторизации. Чтобы оставить или прочитать метку, вам ничего не нужно, кроме самого сайта. Все метки полностью анонимны.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-4">
                        <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="font-bold text-yellow-600">4</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-2">Время жизни меток</h3>
                            <p class="text-gray-600">Каждая метка имеет ограниченное время жизни. После истечения выбранного времени метка автоматически удаляется с карты.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 pt-6 border-t border-gray-100">
                    <button id="startUsing" class="w-full py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors">
                        Начать использовать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data storage
        let markers = JSON.parse(localStorage.getItem('mapMarkers')) || [];
        let map = null;
        let selectedCoords = null;
        let placemarks = [];
        
        // Initialize map when API is loaded
        ymaps.ready(initMap);
        
        function initMap() {
            // Create map centered on Moscow
            map = new ymaps.Map('map', {
                center: [55.7558, 37.6173], // Moscow coordinates
                zoom: 11,
                controls: ['zoomControl', 'fullscreenControl']
            }, {
                searchControlProvider: 'yandex#search'
            });
            
            // Add click event to map for adding markers
            map.events.add('click', function(e) {
                const coords = e.get('coords');
                selectedCoords = coords;
                showAddMarkerPanel(coords);
            });
            
            // Load existing markers
            loadMarkers();
            
            // Update statistics
            updateStatistics();
            
            // Setup zoom controls
            document.getElementById('zoomIn').addEventListener('click', function() {
                map.setZoom(map.getZoom() + 1);
            });
            
            document.getElementById('zoomOut').addEventListener('click', function() {
                map.setZoom(map.getZoom() - 1);
            });
            
            document.getElementById('resetView').addEventListener('click', function() {
                map.setCenter([55.7558, 37.6173], 11);
            });
        }
        
        function showAddMarkerPanel(coords) {
            const panel = document.getElementById('addMarkerPanel');
            panel.classList.remove('hidden');
            panel.classList.add('fade-in');
            
            // Update form coordinates display
            const form = document.getElementById('markerForm');
            form.dataset.coords = JSON.stringify(coords);
        }
        
        function hideAddMarkerPanel() {
            const panel = document.getElementById('addMarkerPanel');
            panel.classList.add('hidden');
            panel.classList.remove('fade-in');
        }
        
        function loadMarkers() {
            // Clear existing placemarks
            placemarks.forEach(pm => map.geoObjects.remove(pm));
            placemarks = [];
            
            // Filter out expired markers
            const now = new Date();
            markers = markers.filter(marker => {
                const expiryTime = new Date(marker.createdAt).getTime() + (marker.duration * 60000);
                return now.getTime() < expiryTime;
            });
            
            // Save filtered markers
            localStorage.setItem('mapMarkers', JSON.stringify(markers));
            
            // Add markers to map
            markers.forEach(marker => {
                const placemark = new ymaps.Placemark(
                    [marker.lat, marker.lng],
                    {
                        balloonContentHeader: marker.title,
                        balloonContentBody: `
                            <div class="marker-popup">
                                <h3>${escapeHtml(marker.title)}</h3>
                                <p>${escapeHtml(marker.text)}</p>
                                <div class="time">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${getTimeAgo(marker.createdAt)}
                                </div>
                                <div class="time mt-2 text-sm">
                                    <i class="fas fa-hourglass-half mr-1"></i>
                                    Исчезнет через: ${getRemainingTime(marker.createdAt, marker.duration)}
                                </div>
                            </div>
                        `,
                        hintContent: marker.title
                    },
                    {
                        preset: 'islands#blueCircleDotIcon',
                        balloonCloseButton: true,
                        hideIconOnBalloonOpen: false
                    }
                );
                
                // Add hover effect
                placemark.events.add('mouseenter', function() {
                    placemark.options.set('preset', 'islands#blueCircleIcon');
                });
                
                placemark.events.add('mouseleave', function() {
                    placemark.options.set('preset', 'islands#blueCircleDotIcon');
                });
                
                map.geoObjects.add(placemark);
                placemarks.push(placemark);
            });
            
            // Update recent markers list
            updateRecentMarkers();
        }
        
        function addMarker(title, text, duration, coords) {
            const marker = {
                id: Date.now(),
                title: title,
                text: text,
                duration: parseInt(duration),
                lat: coords[0],
                lng: coords[1],
                createdAt: new Date().toISOString()
            };
            
            markers.push(marker);
            localStorage.setItem('mapMarkers', JSON.stringify(markers));
            
            // Add to map
            const placemark = new ymaps.Placemark(
                coords,
                {
                    balloonContentHeader: title,
                    balloonContentBody: `
                        <div class="marker-popup">
                            <h3>${escapeHtml(title)}</h3>
                            <p>${escapeHtml(text)}</p>
                            <div class="time">
                                <i class="fas fa-clock mr-1"></i>
                                Только что
                            </div>
                            <div class="time mt-2 text-sm">
                                <i class="fas fa-hourglass-half mr-1"></i>
                                Исчезнет через: ${getDurationText(duration)}
                            </div>
                        </div>
                    `,
                    hintContent: title
                },
                {
                    preset: 'islands#blueCircleDotIcon',
                    balloonCloseButton: true,
                    hideIconOnBalloonOpen: false
                }
            );
            
            // Add hover effect
            placemark.events.add('mouseenter', function() {
                placemark.options.set('preset', 'islands#blueCircleIcon');
            });
            
            placemark.events.add('mouseleave', function() {
                placemark.options.set('preset', 'islands#blueCircleDotIcon');
            });
            
            map.geoObjects.add(placemark);
            placemarks.push(placemark);
            
            // Open balloon for new marker
            placemark.balloon.open();
            
            // Update statistics and recent markers
            updateStatistics();
            updateRecentMarkers();
        }
        
        function updateStatistics() {
            const now = new Date();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayMarkers = markers.filter(marker => 
                new Date(marker.createdAt) >= today
            ).length;
            
            const markers30min = markers.filter(marker => 
                marker.duration === 30
            ).length;
            
            const markers1hour = markers.filter(marker => 
                marker.duration === 60
            ).length;
            
            const markers3hours = markers.filter(marker => 
                marker.duration === 180
            ).length;
            
            const markers12hours = markers.filter(marker => 
                marker.duration === 720
            ).length;
            
            const markers24hours = markers.filter(marker => 
                marker.duration === 1440
            ).length;
            
            document.getElementById('totalMarkers').textContent = markers.length;
            document.getElementById('todayMarkers').textContent = todayMarkers;
            document.getElementById('markers30min').textContent = markers30min;
            document.getElementById('markers1hour').textContent = markers1hour;
            document.getElementById('markers3hours').textContent = markers3hours;
            document.getElementById('markers12hours').textContent = markers12hours;
            document.getElementById('markers24hours').textContent = markers24hours;
        }
        
        function updateRecentMarkers() {
            const container = document.getElementById('recentMarkers');
            
            if (markers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-map-pin text-3xl mb-3 text-gray-300"></i>
                        <p>Пока нет меток</p>
                        <p class="text-sm mt-1">Кликните на карту, чтобы создать первую</p>
                    </div>
                `;
                return;
            }
            
            // Sort by most recent
            const recent = [...markers]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);
            
            container.innerHTML = recent.map(marker => `
                <div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors cursor-pointer" 
                     onclick="showMarkerOnMap(${marker.lat}, ${marker.lng})">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-gray-900 truncate">${escapeHtml(marker.title)}</h4>
                        <span class="text-xs text-gray-500 whitespace-nowrap ml-2">
                            ${getTimeAgo(marker.createdAt)}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 line-clamp-2">${escapeHtml(marker.text)}</p>
                    <div class="flex items-center mt-2 text-xs text-gray-500">
                        <i class="fas fa-hourglass-half mr-1"></i>
                        <span>${getDurationText(marker.duration)}</span>
                    </div>
                </div>
            `).join('');
        }
        
        function showMarkerOnMap(lat, lng) {
            map.setCenter([lat, lng], 15);
            
            // Find and open the placemark's balloon
            const placemark = placemarks.find(pm => 
                pm.geometry.getCoordinates()[0] === lat && 
                pm.geometry.getCoordinates()[1] === lng
            );
            
            if (placemark) {
                placemark.balloon.open();
            }
        }
        
        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Только что';
            if (diffMins < 60) return `${diffMins} мин назад`;
            if (diffHours < 24) return `${diffHours} ч назад`;
            return `${diffDays} дн назад`;
        }
        
        function getRemainingTime(createdAt, duration) {
            const created = new Date(createdAt);
            const expiry = new Date(created.getTime() + (duration * 60000));
            const now = new Date();
            const remainingMs = expiry - now;
            
            if (remainingMs <= 0) return 'Истекло';
            
            const remainingMins = Math.floor(remainingMs / 60000);
            const remainingHours = Math.floor(remainingMins / 60);
            const remainingDays = Math.floor(remainingHours / 24);
            
            if (remainingMins < 60) return `${remainingMins} мин`;
            if (remainingHours < 24) return `${remainingHours} ч`;
            return `${remainingDays} дн`;
        }
        
        function getDurationText(duration) {
            const durations = {
                30: '30 минут',
                60: '1 час',
                180: '3 часа',
                720: '12 часов',
                1440: '24 часа'
            };
            return durations[duration] || `${duration} мин`;
        }
        
        // Event Listeners
        document.getElementById('closePanel').addEventListener('click', hideAddMarkerPanel);
        
        document.getElementById('markerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('markerTitle').value.trim();
            const text = document.getElementById('markerText').value.trim();
            const duration = document.querySelector('input[name="duration"]:checked').value;
            const coords = JSON.parse(this.dataset.coords);
            
            if (!title || !text) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            addMarker(title, text, duration, coords);
            
            // Reset form
            this.reset();
            document.querySelector('input[name="duration"][value="30"]').checked = true;
            hideAddMarkerPanel();
            
            // Show success message
            showNotification('Метка успешно добавлена на карту!', 'success');
        });
        
        // Instructions modal
        document.getElementById('instructionsBtn').addEventListener('click', function() {
            document.getElementById('instructionsModal').classList.remove('hidden');
        });
        
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('instructionsModal').classList.add('hidden');
        });
        
        document.getElementById('startUsing').addEventListener('click', function() {
            document.getElementById('instructionsModal').classList.add('hidden');
        });
        
        // Close modal on outside click
        document.getElementById('instructionsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });
        
        // Close panel on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideAddMarkerPanel();
                document.getElementById('instructionsModal').classList.add('hidden');
            }
        });
        
        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 fade-in ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('fade-in');
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Auto-refresh markers every minute to remove expired ones
        setInterval(() => {
            loadMarkers();
            updateStatistics();
        }, 60000);
        
        // Initial load of recent markers
        updateRecentMarkers();
        
        // Show instructions on first visit
        if (!localStorage.getItem('hasVisited')) {
            setTimeout(() => {
                document.getElementById('instructionsModal').classList.remove('hidden');
                localStorage.setItem('hasVisited', 'true');
            }, 1000);
        }
    </script>
</body>
</html>